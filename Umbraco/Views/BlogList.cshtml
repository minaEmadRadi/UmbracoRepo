@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<BlogList>
@{
    Layout = "_Layout";
    var language = System.Threading.Thread.CurrentThread.CurrentCulture.Name;
}
@await Html.PartialAsync("~/Views/Partials/_Header.cshtml",Model)
<article class="mb-4">
    <div class="container px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-md-10 col-lg-8 col-xl-7">
                <div id="partial-content">
                </div>
            </div>
        </div>
    </div>
</article>

@section Scripts {
    
    <script>
          const translations = {
            'en': {
                next: 'Next →',
                back: '← Back'
            },
            'ar': {
                next: 'التالي ←',
                back: '→ السابق'
            }
        };
        
        function loadPage(pageNumber) {
            
            const skip = (pageNumber - 1) * 3;

            var settings = 
            {
              "url": `https://localhost:44355/umbraco/delivery/api/v2/content?fetch=Children:Blogs&skip=${skip}&take=3`,
              "method": "GET",
              "timeout": 0,
              "headers": {
                "Accept-Language": "@language",
                "Api-Key": "Mina-Emad-Radi"
              },
            };

            $.ajax(settings).done(function (response) 
            {




                $('#partial-content').html('');
                const lang = "@language" === "ar" ? "ar-EG" : "@language";

                let contentHtml = '';

                console.log(response.items);
                response.items.forEach(item => {

                   
                   const imgUrl = item.properties.headerImage?.url || '';
                   const bannerCrop = item.properties.headerImage?.crops?.find(crop => crop.alias === 'Listing');

                   let croppedImageUrl = '';
                   
                   if (bannerCrop) 
                   {
                       const { coordinates, width, height } = bannerCrop;
                       if(coordinates){
                       const { x1, y1, x2, y2 } = coordinates;
                       croppedImageUrl = ` <img src="https://localhost:44355${imgUrl}?cc=${x1},${y1},${x2},${y2}&width=${width}&height=${height} alt="${item.properties.title}" class="img-fluid mb-3 list-image" />`;
                       }else{
                       croppedImageUrl = ` <img src="https://localhost:44355${imgUrl}?cc=0,0,0,0&width=${width}&height=${height} alt="${item.properties.title}" class="img-fluid mb-3 list-image" />`;
                       }
                   }

                   const createDate = item.createDate ? new Date(item.createDate).toLocaleDateString(lang, {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        }) : 'N/A';



                    contentHtml += `
                        <hr class="my-4" />
                         <div class="row">
                        <div class="post-preview col-9">
                            <a href="${item.route.path}">
                                
                                <h2 class="post-title">${item.properties.title}</h2>
                            </a>
                             <a href="${item.route.path}">

                                <h3 class="post-subtitle">${item.properties.subtitle}</h3>
                            </a>
                            <span class="badge bg-secondary">${item.properties.categories[0].name || 'Uncategorized'}</span>
                               <p class="post-meta" style="display: inline;">
                                         ${ createDate || 'N/A'}
                            </p>
                        </div>
                        <div class="col-3 ">
                        ${croppedImageUrl}
                        </div>
                        </div>
                        <hr class="my-4" />
                    `;
                });

                const currentTranslations = translations["@language"] || translations['en'];

                let paginationHtml = `
                    <div class="d-flex ${"@language" === 'ar' ? 'flex-row-reverse' : ''} justify-content-between mb-4">
                        ${pageNumber > 1 ?
                            `<a class="btn btn-primary text-uppercase" onclick="loadPage(${pageNumber - 1})">${currentTranslations.back}</a>`
                            : ''}
                        ${skip + response.items.length < response.total ?
                            `<a class="btn btn-primary text-uppercase" onclick="loadPage(${pageNumber + 1})">${currentTranslations.next}</a>`
                            : ''}
                    </div>
                `;

                $('#partial-content').html(contentHtml + paginationHtml);




              })

              .fail(function (xhr, status, error) {
                    console.error(`Error: ${xhr.status} - ${error}`);
                    alert('Failed to load data. Please try again later.');});
        }



        $(document).ready(function() {

            loadPage(1);
        });
    </script>
}
